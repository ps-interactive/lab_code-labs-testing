<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Item Details - Vulnerable Auction Site</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/styles.css">
    <script>
        // A3: Injection - JavaScript injection vulnerability
        function processParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const callback = urlParams.get('callback');
            
            // A3: JavaScript Injection vulnerability
            if (callback) {
                eval(callback + '()');
            }
        }
        
        window.onload = processParams;
    </script>
</head>
<body>
    <header>
        <h1>Premier Auctions</h1>
        <nav>
            <a href="/">Home</a>
            <div class="auth-container" th:if="${user != null}">
                <p>Welcome, <span th:text="${user.username}"></span>!</p>
                <a href="/logout" class="btn btn-secondary">Logout</a>
            </div>
            <div th:if="${user == null}">
                <a href="/login" class="btn btn-primary">Login</a>
                <a href="/register" class="btn btn-secondary">Register</a>
            </div>
        </nav>
    </header>
    
    <div class="item-detail-container" th:if="${item != null}">
        <!-- A3: Injection - Stored XSS vulnerability -->
        <h2 th:utext="${item.name}"></h2>
        <div class="row mt-4">
            <div class="col">
                <div class="item-image" style="height: 300px;"></div>
            </div>
            <div class="col">
                <div class="mb-4">
                    <h3>Item Details</h3>
                    <p><strong>Description:</strong> <span th:utext="${item.description}"></span></p>
                    <p class="item-price mb-3"><strong>Current Bid:</strong> $<span th:text="${item.currentBid}"></span></p>
                    <p><strong>Seller:</strong> <span th:text="${item.seller?.username}"></span></p>
                    <p><strong>Auction Ends:</strong> <span th:text="${item.endTime}"></span></p>
                </div>
            </div>
        </div>
        
        <div class="bid-form" th:if="${user != null}">
            <!-- A7: CSRF vulnerability (no anti-CSRF token) -->
            <!-- A5: Security Misconfiguration - No server-side validation -->
            <h3>Place Your Bid</h3>
            <form th:action="@{'/api/bids/' + ${item.id}}" method="post">
                <div class="form-group">
                    <label for="amount">Bid Amount ($):</label>
                    <input type="number" id="amount" name="amount" step="0.01" required>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Place Bid</button>
                </div>
            </form>
        </div>
        
        <div class="mt-4" th:if="${user != null && user.id == item.seller?.id}">
            <h3>Upload Item Image</h3>
            <!-- A8: Software and Data Integrity Failures - Insecure file upload -->
            <form th:action="@{'/api/items/' + ${item.id} + '/image'}" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="file">Image File:</label>
                    <input type="file" id="file" name="file" accept="image/*">
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-secondary">Upload</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- A2: Cryptographic Failures - Hidden sensitive data in HTML -->
    <div style="display: none;" th:if="${item != null && item.seller != null}">
        <p id="sellerEmail" th:text="${item.seller.email}"></p>
        <p id="sellerCreditCard" th:text="${item.seller.creditCardNumber}"></p>
    </div>
    
    <script th:if="${user != null && user.admin}">
        // A1: Broken Access Control - Insecure direct object reference
        function deleteItem() {
            if (confirm('Are you sure you want to delete this item?')) {
                fetch('/api/items/' + [[${item.id}]], {
                    method: 'DELETE'
                }).then(() => {
                    window.location.href = '/';
                });
            }
        }
        
        document.write('<div class="mt-4"><button onclick="deleteItem()" class="btn btn-danger">Delete Item (Admin)</button></div>');
    </script>
</body>
</html>